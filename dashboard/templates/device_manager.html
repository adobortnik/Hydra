{% extends "base.html" %}
{% block title %}Device Manager - Hydra{% endblock %}

{% block extra_css %}
<style>
    .status-dot {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 6px;
        vertical-align: middle;
    }
    .status-dot.connected { background: #28a745; box-shadow: 0 0 6px #28a745; }
    .status-dot.disconnected { background: #dc3545; box-shadow: 0 0 6px #dc3545; }
    .status-dot.error { background: #ffc107; box-shadow: 0 0 6px #ffc107; }

    .bot-badge {
        font-size: 0.7rem;
        padding: 2px 8px;
        border-radius: 10px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .bot-badge.active { background: #28a74533; color: #28a745; border: 1px solid #28a74555; }
    .bot-badge.hung { background: #ffc10733; color: #ffc107; border: 1px solid #ffc10755; }
    .bot-badge.stopped { background: #6c757d33; color: #6c757d; border: 1px solid #6c757d55; }

    .btn-action {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        padding: 6px 14px;
        font-size: 0.78rem;
        border-radius: 6px;
        font-weight: 600;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none !important;
        white-space: nowrap;
    }
    .btn-action:hover { opacity: 0.85; transform: translateY(-1px); box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
    .btn-action:active { transform: translateY(0); }
    .btn-start { background: #22c55e; color: #fff; }
    .btn-start:hover { background: #16a34a; color: #fff; }
    .btn-stop { background: #52525b; color: #e4e4e7; }
    .btn-stop:hover { background: #71717a; color: #fff; }
    .btn-manage { background: linear-gradient(135deg, #f97316, #ea580c); color: #fff; }
    .btn-manage:hover { background: linear-gradient(135deg, #fb923c, #f97316); color: #fff; }
    .btn-delete { background: #ef4444; color: #fff; }
    .btn-delete:hover { background: #dc2626; color: #fff; }
    .btn-edit { background: #3b82f6; color: #fff; }
    .btn-edit:hover { background: #2563eb; color: #fff; }
    .action-btns { display: flex; gap: 6px; align-items: center; flex-wrap: wrap; }

    .device-table th { 
        font-size: 0.8rem; 
        text-transform: uppercase; 
        letter-spacing: 0.5px; 
        color: #9ca3af;
        border-bottom: 2px solid #2d3238;
        padding: 12px 10px;
    }
    .device-table td {
        padding: 10px;
        vertical-align: middle;
        border-bottom: 1px solid #2d3238;
    }
    .device-table tr:hover { background: #1e2228; }

    .stat-card {
        background: linear-gradient(145deg, #1a1d21, #22262b);
        border-radius: 10px;
        padding: 20px 24px;
        text-align: center;
        border: 1px solid #2d3238;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .stat-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
    .stat-card .stat-value { font-size: 2rem; font-weight: 700; font-variant-numeric: tabular-nums; }
    .stat-card .stat-label { font-size: 0.75rem; color: #9ca3af; margin-top: 6px; text-transform: uppercase; letter-spacing: 0.5px; }

    .device-serial { font-family: 'JetBrains Mono', 'Courier New', monospace; font-size: 0.82rem; color: #71717a; }
    .device-name { font-weight: 600; color: #e4e4e7; }
    .account-badge { 
        background: #3b82f620; 
        color: #60a5fa; 
        border: 1px solid #3b82f640;
        padding: 3px 10px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    /* Quick Search */
    .search-wrapper {
        position: relative;
    }
    .search-wrapper .search-icon {
        position: absolute;
        left: 14px;
        top: 50%;
        transform: translateY(-50%);
        color: #6b7280;
        pointer-events: none;
        transition: color 0.2s;
    }
    .search-wrapper input:focus ~ .search-icon,
    .search-wrapper input:not(:placeholder-shown) ~ .search-icon {
        color: #f59e0b;
    }
    .search-wrapper input {
        padding-left: 40px;
        padding-right: 40px;
        height: 44px;
        font-size: 0.92rem;
        border-radius: 8px;
        transition: border-color 0.2s, box-shadow 0.2s;
    }
    .search-wrapper input:focus {
        border-color: #f59e0b !important;
        box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.15);
    }
    .search-wrapper input::placeholder {
        color: #6b7280;
    }
    .search-clear {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: #6b7280;
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.9rem;
        display: none;
        transition: color 0.2s, background 0.2s;
    }
    .search-clear:hover {
        color: #ef4444;
        background: #ef444420;
    }
    .search-clear.visible {
        display: block;
    }
    .search-count {
        font-size: 0.78rem;
        color: #6b7280;
        margin-top: 6px;
        transition: color 0.2s;
    }
    .search-count.filtered {
        color: #f59e0b;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-server me-2 text-warning"></i>Device Manager</h2>
    <div>
        <button class="btn btn-success me-2" onclick="discoverDevices()">
            <i class="fas fa-search me-1"></i> Discover Devices
        </button>
        <button class="btn btn-outline-light me-2" data-bs-toggle="modal" data-bs-target="#addDeviceModal">
            <i class="fas fa-plus me-1"></i> Add Device
        </button>
        <button class="btn btn-sm btn-outline-secondary" onclick="refreshDevices()">
            <i class="fas fa-sync-alt me-1"></i> Refresh
        </button>
    </div>
</div>

<!-- Discovery Results Panel (hidden by default) -->
<div class="card bg-dark border-success mb-4 d-none" id="discoveryPanel">
    <div class="card-header bg-dark border-success d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fas fa-broadcast-tower me-2 text-success"></i>Discovery Results</h5>
        <button class="btn btn-sm btn-outline-secondary" onclick="document.getElementById('discoveryPanel').classList.add('d-none')">
            <i class="fas fa-times"></i>
        </button>
    </div>
    <div class="card-body" id="discoveryBody"></div>
</div>

<!-- Stats Row -->
<div class="row mb-4" id="statsRow">
    <div class="col-md-3 mb-3">
        <div class="stat-card">
            <div class="stat-value text-warning" id="statTotal">-</div>
            <div class="stat-label">Total Devices</div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="stat-card">
            <div class="stat-value text-success" id="statOnline">-</div>
            <div class="stat-label">Online</div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="stat-card">
            <div class="stat-value text-danger" id="statOffline">-</div>
            <div class="stat-label">Offline</div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="stat-card">
            <div class="stat-value text-info" id="statAccounts">-</div>
            <div class="stat-label">Total Accounts</div>
        </div>
    </div>
</div>

<!-- Quick Search -->
<div class="mb-3">
    <div class="search-wrapper">
        <input type="text" id="deviceSearch" class="form-control bg-dark text-white border-secondary" 
               placeholder="Search devices — name, serial, IP, status, account..." autocomplete="off" spellcheck="false">
        <i class="fas fa-search search-icon"></i>
        <button type="button" class="search-clear" id="searchClear" title="Clear search (Esc)">
            <i class="fas fa-times"></i>
        </button>
    </div>
    <div class="search-count d-none" id="searchCount"></div>
</div>

<!-- Device Table -->
<div class="card bg-dark border-secondary">
    <div class="card-header bg-dark border-secondary d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fas fa-mobile-alt me-2"></i>All Devices</h5>
        <span class="text-muted small" id="lastRefresh"></span>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-dark device-table mb-0">
                <thead>
                    <tr>
                        <th style="width:50px">Status</th>
                        <th>Device ID</th>
                        <th>Device Name</th>
                        <th style="width:100px">Accounts</th>
                        <th style="width:100px">Bot</th>
                        <th style="width:320px">Actions</th>
                    </tr>
                </thead>
                <tbody id="deviceTableBody">
                    <tr>
                        <td colspan="6" class="text-center text-muted py-4">
                            <i class="fas fa-spinner fa-spin me-2"></i>Loading devices...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add Device Modal -->
<div class="modal fade" id="addDeviceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header border-secondary">
                <h5 class="modal-title"><i class="fas fa-plus me-2"></i>Add Device</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">IP Address</label>
                    <input type="text" class="form-control bg-dark text-white border-secondary" id="addIp" placeholder="10.1.10.200">
                </div>
                <div class="mb-3">
                    <label class="form-label">ADB Port</label>
                    <input type="number" class="form-control bg-dark text-white border-secondary" id="addPort" value="5555">
                </div>
                <div class="mb-3">
                    <label class="form-label">Friendly Name</label>
                    <input type="text" class="form-control bg-dark text-white border-secondary" id="addName" placeholder="JACK 51">
                </div>
                <div class="mb-3">
                    <label class="form-label">Notes</label>
                    <textarea class="form-control bg-dark text-white border-secondary" id="addNotes" rows="2"></textarea>
                </div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="addDevice()">
                    <i class="fas fa-plus me-1"></i> Add Device
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Device Modal -->
<div class="modal fade" id="editDeviceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header border-secondary">
                <h5 class="modal-title"><i class="fas fa-edit me-2"></i>Edit Device</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editDeviceId">
                <div class="mb-3">
                    <label class="form-label">Serial</label>
                    <input type="text" class="form-control bg-dark text-white border-secondary" id="editSerial" disabled>
                </div>
                <div class="mb-3">
                    <label class="form-label">Friendly Name</label>
                    <input type="text" class="form-control bg-dark text-white border-secondary" id="editName">
                </div>
                <div class="mb-3">
                    <label class="form-label">Notes</label>
                    <textarea class="form-control bg-dark text-white border-secondary" id="editNotes" rows="2"></textarea>
                </div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveDevice()">
                    <i class="fas fa-save me-1"></i> Save
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let devicesData = [];

function refreshDevices() {
    fetch('/api/device-manager/devices')
        .then(r => r.json())
        .then(data => {
            if (data.error) {
                showError(data.error);
                return;
            }
            devicesData = data.devices || [];
            renderDevices(devicesData);
            updateStats(devicesData);
            document.getElementById('lastRefresh').textContent = 
                'Updated: ' + new Date().toLocaleTimeString();
        })
        .catch(err => showError('Failed to load devices: ' + err));
}

function renderDevices(devices) {
    const tbody = document.getElementById('deviceTableBody');
    
    if (!devices.length) {
        tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted py-4">
            <i class="fas fa-inbox me-2"></i>No devices found
        </td></tr>`;
        return;
    }

    tbody.innerHTML = devices.map(dev => {
        const statusClass = dev.status === 'connected' ? 'connected' : 
                           dev.status === 'error' ? 'error' : 'disconnected';
        const botClass = dev.bot_status === 'active' ? 'active' :
                        dev.bot_status === 'hung' ? 'hung' : 'stopped';
        const botLabel = dev.bot_status || 'stopped';
        
        // Encode serial for URL (replace special chars)
        const serialEncoded = encodeURIComponent(dev.device_serial);

        return `<tr>
            <td><span class="status-dot ${statusClass}" title="${dev.status}"></span></td>
            <td class="device-serial">${escHtml(dev.device_serial)}</td>
            <td class="device-name">${escHtml(dev.device_name || '-')}</td>
            <td><span class="account-badge">${dev.account_count || 0}</span></td>
            <td><span class="bot-badge ${botClass}">${botLabel}</span></td>
            <td>
                <div class="action-btns">
                    <button class="btn-action btn-start" onclick="startBot('${escAttr(dev.device_serial)}')" title="Start Bot">
                        <i class="fas fa-play fa-xs"></i> Start
                    </button>
                    <button class="btn-action btn-stop" onclick="stopBot('${escAttr(dev.device_serial)}')" title="Stop Bot">
                        <i class="fas fa-stop fa-xs"></i> Stop
                    </button>
                    <button class="btn-action" style="background:rgba(99,102,241,0.2);color:#818cf8;border-color:#818cf8;" onclick="mirrorDevice('${escAttr(dev.device_serial)}')" title="Mirror Screen">
                        <i class="fas fa-eye fa-xs"></i>
                    </button>
                    <a href="/device-manager/${serialEncoded}" class="btn-action btn-manage">
                        <i class="fas fa-cogs fa-xs"></i> Manage
                    </a>
                    <button class="btn-action btn-edit" onclick="editDevice(${dev.id}, '${escAttr(dev.device_serial)}', '${escAttr(dev.device_name||'')}', '${escAttr(dev.notes||'')}')" title="Edit">
                        <i class="fas fa-edit fa-xs"></i>
                    </button>
                </div>
            </td>
        </tr>`;
    }).join('');
}

function updateStats(devices) {
    const total = devices.length;
    const online = devices.filter(d => d.status === 'connected').length;
    const offline = total - online;
    const accounts = devices.reduce((sum, d) => sum + (d.account_count || 0), 0);

    document.getElementById('statTotal').textContent = total;
    document.getElementById('statOnline').textContent = online;
    document.getElementById('statOffline').textContent = offline;
    document.getElementById('statAccounts').textContent = accounts;
}

function mirrorDevice(serial) {
    fetch(`/api/device-manager/${encodeURIComponent(serial)}/mirror`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                showToast('Screen mirror starting...', 'success');
            } else {
                showToast('Mirror failed: ' + (data.error || 'Unknown error'), 'danger');
            }
        })
        .catch(e => showToast('Mirror error: ' + e, 'danger'));
}

function startBot(serial) {
    const btn = event.target.closest('.btn-start');
    const originalHtml = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    btn.disabled = true;

    fetch(`/api/bot/launch/${encodeURIComponent(serial)}`, { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                showToast(`Bot started for ${serial}`, 'success');
                refreshDevices();
            } else {
                showToast(data.message || data.error || 'Failed to start', 'warning');
            }
        })
        .catch(err => {
            showToast('Error starting bot: ' + err, 'danger');
        })
        .finally(() => {
            btn.innerHTML = originalHtml;
            btn.disabled = false;
        });
}

function stopBot(serial) {
    const btn = event.target.closest('.btn-stop');
    const originalHtml = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    btn.disabled = true;

    fetch(`/api/bot/stop/${encodeURIComponent(serial)}`, { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                showToast(`Bot stopped for ${serial}`, 'success');
                refreshDevices();
            } else {
                showToast(data.message || data.error || 'Failed to stop', 'warning');
            }
        })
        .catch(err => {
            showToast('Error stopping bot: ' + err, 'danger');
        })
        .finally(() => {
            btn.innerHTML = originalHtml;
            btn.disabled = false;
        });
}

function showToast(message, type = 'info') {
    // Create toast container if it doesn't exist
    let container = document.getElementById('toastContainer');
    if (!container) {
        container = document.createElement('div');
        container.id = 'toastContainer';
        container.style.cssText = 'position:fixed;top:20px;right:20px;z-index:9999;';
        document.body.appendChild(container);
    }

    const toast = document.createElement('div');
    toast.className = `alert alert-${type} alert-dismissible fade show`;
    toast.style.cssText = 'min-width:280px;box-shadow:0 4px 12px rgba(0,0,0,0.4);margin-bottom:10px;';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    container.appendChild(toast);

    // Auto-dismiss after 4s
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    }, 4000);
}

function showError(msg) {
    document.getElementById('deviceTableBody').innerHTML = 
        `<tr><td colspan="6" class="text-center text-danger py-4">
            <i class="fas fa-exclamation-triangle me-2"></i>${escHtml(msg)}
        </td></tr>`;
}

function escHtml(str) {
    if (!str) return '';
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

function escAttr(str) {
    return String(str || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
}

// ============ Discovery & Device Management ============

function discoverDevices() {
    const btn = event.target.closest('button');
    const originalHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Scanning...';

    fetch('/api/devices/discover')
        .then(r => r.json())
        .then(data => {
            btn.disabled = false;
            btn.innerHTML = originalHtml;

            if (data.status !== 'success') {
                showToast('Discovery failed: ' + (data.message || 'Unknown error'), 'danger');
                return;
            }

            let html = '';

            // New devices found
            if (data.new_devices && data.new_devices.length > 0) {
                html += `<h6 class="text-success"><i class="fas fa-plus-circle me-1"></i> New Devices (${data.new_devices.length})</h6>`;
                html += '<div class="table-responsive"><table class="table table-dark table-sm mb-3"><thead><tr><th>Serial</th><th>IP</th><th>Port</th><th>Action</th></tr></thead><tbody>';
                data.new_devices.forEach(d => {
                    html += `<tr>
                        <td><code class="text-success">${escHtml(d.db_serial)}</code></td>
                        <td>${escHtml(d.ip_address)}</td>
                        <td>${d.adb_port}</td>
                        <td><button class="btn btn-sm btn-success" onclick="quickAdd('${escAttr(d.db_serial)}', '${escAttr(d.ip_address)}', ${d.adb_port})">
                            <i class="fas fa-plus me-1"></i>Add</button></td>
                    </tr>`;
                });
                html += '</tbody></table></div>';
            }

            // Summary
            html += `<div class="d-flex gap-3 mt-2">
                <span class="text-success"><i class="fas fa-check-circle me-1"></i>${(data.online_devices || []).length} online</span>
                <span class="text-secondary"><i class="fas fa-times-circle me-1"></i>${(data.offline_devices || []).length} offline</span>
                <span class="text-info"><i class="fas fa-broadcast-tower me-1"></i>${data.adb_count || 0} ADB devices</span>
                <span class="text-warning"><i class="fas fa-plus-circle me-1"></i>${(data.new_devices || []).length} new</span>
            </div>`;

            if (!data.new_devices || data.new_devices.length === 0) {
                html += '<p class="text-muted mt-2 mb-0">All connected devices are already in the database.</p>';
            }

            document.getElementById('discoveryBody').innerHTML = html;
            document.getElementById('discoveryPanel').classList.remove('d-none');

            refreshDevices();
        })
        .catch(err => {
            btn.disabled = false;
            btn.innerHTML = originalHtml;
            showToast('Discovery request failed: ' + err, 'danger');
        });
}

function quickAdd(serial, ip, port) {
    const btn = event.target.closest('button');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

    fetch('/api/devices/add', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            device_serial: serial,
            ip_address: ip,
            adb_port: port,
            device_name: ip
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.status === 'success') {
            btn.outerHTML = '<span class="badge bg-success">Added ✓</span>';
            refreshDevices();
        } else {
            showToast(data.message || 'Failed to add', 'danger');
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-plus me-1"></i>Add';
        }
    })
    .catch(err => {
        showToast('Error: ' + err, 'danger');
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-plus me-1"></i>Add';
    });
}

function addDevice() {
    const ip = document.getElementById('addIp').value.trim();
    const port = parseInt(document.getElementById('addPort').value) || 5555;
    const name = document.getElementById('addName').value.trim();
    const notes = document.getElementById('addNotes').value.trim();

    if (!ip) {
        showToast('IP address is required', 'warning');
        return;
    }

    fetch('/api/devices/add', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            ip_address: ip,
            adb_port: port,
            device_name: name || ip,
            notes: notes
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.status === 'success') {
            bootstrap.Modal.getInstance(document.getElementById('addDeviceModal')).hide();
            document.getElementById('addIp').value = '';
            document.getElementById('addName').value = '';
            document.getElementById('addNotes').value = '';
            showToast('Device added successfully', 'success');
            refreshDevices();
        } else {
            showToast(data.message || 'Failed to add device', 'danger');
        }
    })
    .catch(err => {
        showToast('Error: ' + err, 'danger');
    });
}

function editDevice(id, serial, name, notes) {
    document.getElementById('editDeviceId').value = id;
    document.getElementById('editSerial').value = serial;
    document.getElementById('editName').value = name;
    document.getElementById('editNotes').value = notes;
    new bootstrap.Modal(document.getElementById('editDeviceModal')).show();
}

function saveDevice() {
    const id = document.getElementById('editDeviceId').value;
    const name = document.getElementById('editName').value.trim();
    const notes = document.getElementById('editNotes').value.trim();

    fetch(`/api/devices/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ device_name: name, notes: notes })
    })
    .then(r => r.json())
    .then(data => {
        if (data.status === 'success') {
            bootstrap.Modal.getInstance(document.getElementById('editDeviceModal')).hide();
            showToast('Device updated', 'success');
            refreshDevices();
        } else {
            showToast(data.message || 'Failed to save', 'danger');
        }
    })
    .catch(err => {
        showToast('Error: ' + err, 'danger');
    });
}

// ============ Quick Search / Filter ============

const searchInput = document.getElementById('deviceSearch');
const searchClear = document.getElementById('searchClear');
const searchCount = document.getElementById('searchCount');

function filterDevices() {
    const query = searchInput.value.trim().toLowerCase();
    const tbody = document.getElementById('deviceTableBody');
    const rows = tbody.querySelectorAll('tr');
    
    // Toggle clear button
    searchClear.classList.toggle('visible', query.length > 0);
    
    if (!query) {
        // Show all rows
        rows.forEach(r => r.style.display = '');
        searchCount.classList.add('d-none');
        searchCount.classList.remove('filtered');
        return;
    }
    
    let visible = 0;
    let total = 0;
    
    rows.forEach(row => {
        // Skip placeholder rows (loading, empty, error)
        if (row.querySelector('td[colspan]')) return;
        total++;
        const text = row.textContent.toLowerCase();
        if (text.includes(query)) {
            row.style.display = '';
            visible++;
        } else {
            row.style.display = 'none';
        }
    });
    
    // If total is 0, the table might still be loading
    if (total === 0) {
        searchCount.classList.add('d-none');
        return;
    }
    
    searchCount.classList.remove('d-none');
    searchCount.classList.toggle('filtered', visible < total);
    searchCount.textContent = `Showing ${visible} of ${total} device${total !== 1 ? 's' : ''}`;
}

searchInput.addEventListener('input', filterDevices);

searchClear.addEventListener('click', () => {
    searchInput.value = '';
    filterDevices();
    searchInput.focus();
});

// Escape key clears search
searchInput.addEventListener('keydown', e => {
    if (e.key === 'Escape') {
        searchInput.value = '';
        filterDevices();
        searchInput.blur();
    }
});

// Ctrl+F focuses search instead of browser find
document.addEventListener('keydown', e => {
    if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
        e.preventDefault();
        searchInput.focus();
        searchInput.select();
    }
});

// Re-apply filter after devices re-render (e.g. from refresh)
const _origRender = renderDevices;
renderDevices = function(devices) {
    _origRender(devices);
    filterDevices();
};

// Initial load + auto-refresh every 30s
refreshDevices();
setInterval(refreshDevices, 30000);
</script>
{% endblock %}
