{% extends "base.html" %}

{% block title %}Job Orders - Hydra Dashboard{% endblock %}

{% block extra_css %}
<style>
    .job-type-card {
        border: 2px solid #495057;
        border-radius: 10px;
        padding: 2rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: #2c3034;
        height: 150px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }

    .job-type-card:hover {
        border-color: #0d6efd;
        background: #343a40;
        transform: translateY(-5px);
    }

    .job-type-card i {
        font-size: 3rem;
        margin-bottom: 0.5rem;
        color: #6c757d;
    }

    .job-type-card:hover i {
        color: #0d6efd;
    }

    .job-type-card span {
        font-size: 1.1rem;
        font-weight: 500;
        color: #e0e0e0;
    }

    .modal-lg-custom {
        max-width: 900px;
    }

    .accounts-table {
        max-height: 400px;
        overflow-y: auto;
    }

    .accounts-table table {
        margin-bottom: 0;
    }

    .job-status-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.85rem;
    }

    .progress-text {
        font-weight: 600;
        color: #0d6efd;
    }

    .action-btn {
        padding: 0.25rem 0.5rem;
        margin: 0 0.1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2 class="text-light">
                    <i class="fas fa-tasks me-2"></i>Job Orders
                </h2>
                <button class="btn btn-primary" onclick="showJobTypeModal()">
                    <i class="fas fa-plus me-2"></i>Add Job
                </button>
            </div>
        </div>
    </div>

    <!-- Jobs Table -->
    <div class="row">
        <div class="col-12">
            <div class="card bg-dark text-light">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-dark table-hover" id="jobsTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Target</th>
                                    <th>Ordered</th>
                                    <th>Accounts</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="jobsTableBody">
                                <!-- Jobs will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal 1: Select Job Type -->
<div class="modal fade" id="jobTypeModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Select Job Type Campaign</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="job-type-card" onclick="selectJobType('follow')">
                            <i class="fas fa-user-plus"></i>
                            <span>Follow</span>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="job-type-card" onclick="selectJobType('like')">
                            <i class="fas fa-heart"></i>
                            <span>Like</span>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="job-type-card" onclick="selectJobType('comment')">
                            <i class="fas fa-comment"></i>
                            <span>Comment</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">CANCEL</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal 2: Add Follow Job -->
<div class="modal fade" id="followJobModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Add Follow Job</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="followJobForm">
                    <div class="mb-3">
                        <label class="form-label">Job Name</label>
                        <input type="text" class="form-control" id="follow_job_name" value="Follow_" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Target Username</label>
                        <input type="text" class="form-control" id="follow_target" placeholder="username" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Follows To Deliver</label>
                        <input type="number" class="form-control" id="follow_total" value="1000" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Limit Number of Follows per Hour</label>
                        <input type="number" class="form-control" id="follow_per_hour" value="100" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Limit Number of Follows per Day</label>
                        <input type="number" class="form-control" id="follow_per_day" value="500" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">CANCEL</button>
                <button type="button" class="btn btn-primary" onclick="saveFollowJob()">SAVE AND SELECT ACCOUNTS</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal 3: Add Like Job -->
<div class="modal fade" id="likeJobModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Add Like Job</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="likeJobForm">
                    <div class="mb-3">
                        <label class="form-label">Job Name</label>
                        <input type="text" class="form-control" id="like_job_name" value="Like_" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Target Post Url</label>
                        <input type="text" class="form-control" id="like_target" placeholder="https://www.instagram.com/p/..." required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Likes To Deliver</label>
                        <input type="number" class="form-control" id="like_total" value="1000" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Limit Number of Likes per Hour</label>
                        <input type="number" class="form-control" id="like_per_hour" value="100" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Limit Number of Likes per Day</label>
                        <input type="number" class="form-control" id="like_per_day" value="500" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">CANCEL</button>
                <button type="button" class="btn btn-primary" onclick="saveLikeJob()">SAVE AND SELECT ACCOUNTS</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal 4: Add Comment Job -->
<div class="modal fade" id="commentJobModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Add Comment Job</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="commentJobForm">
                    <div class="mb-3">
                        <label class="form-label">Job Name</label>
                        <input type="text" class="form-control" id="comment_job_name" value="Comment_" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Target Post Url</label>
                        <input type="text" class="form-control" id="comment_target" placeholder="https://www.instagram.com/p/..." required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Comments To Deliver</label>
                        <input type="number" class="form-control" id="comment_total" value="1000" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Limit Number of Comments per Hour</label>
                        <input type="number" class="form-control" id="comment_per_hour" value="100" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Limit Number of Comments per Day</label>
                        <input type="number" class="form-control" id="comment_per_day" value="500" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Comment</label>
                        <textarea class="form-control" id="comment_text" rows="4" placeholder="Enter your comment here..."></textarea>
                        <small class="text-muted">Accepts Spin Syntax and [AI] generated comments.</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">CANCEL</button>
                <button type="button" class="btn btn-primary" onclick="saveCommentJob()">SAVE AND SELECT ACCOUNTS</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal 5: Select Accounts -->
<div class="modal fade" id="selectAccountsModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-lg-custom modal-dialog-centered">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Select Accounts</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Job Summary -->
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label text-muted">ID :</label>
                        <input type="text" class="form-control" id="summary_job_id" readonly>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label text-muted">Job Name :</label>
                        <input type="text" class="form-control" id="summary_job_name" readonly>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label text-muted">Target :</label>
                        <input type="text" class="form-control" id="summary_target" readonly>
                    </div>
                </div>

                <!-- Info Message -->
                <div class="alert alert-info">
                    Select accounts that you want to use to execute your <span id="jobTypeText">follow</span> actions.
                    You have selected <strong id="selectedCount">0</strong> accounts out of <strong id="totalOrders">0</strong> orders.
                    <br><small>Actions will be executed on a maximum of <strong id="maxAccounts">1000</strong> selected accounts only, even if more accounts are selected.</small>
                </div>

                <!-- Search Bar -->
                <div class="mb-3">
                    <input type="text" class="form-control" id="accountSearch" placeholder="Search accounts...">
                </div>

                <!-- Accounts Table -->
                <div class="accounts-table">
                    <table class="table table-dark table-hover">
                        <thead>
                            <tr>
                                <th style="width: 50px;">
                                    <input type="checkbox" id="selectAllAccounts" onchange="toggleSelectAll()">
                                </th>
                                <th>Device</th>
                                <th>Username</th>
                            </tr>
                        </thead>
                        <tbody id="accountsTableBody">
                            <!-- Accounts will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">CANCEL</button>
                <button type="button" class="btn btn-primary" onclick="saveJobWithAccounts()">SAVE</button>
            </div>
        </div>
    </div>
</div>

<!-- Toast for notifications -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11000">
    <div id="jobToast" class="toast align-items-center text-white border-0" role="alert">
        <div class="d-flex">
            <div class="toast-body" id="toastMessage"></div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentJobData = {};
let availableAccounts = [];
let tempJobId = null;

// Load jobs on page load
$(document).ready(function() {
    loadJobs();
    loadAvailableAccounts();

    // Setup search
    $('#accountSearch').on('input', function() {
        filterAccounts($(this).val());
    });
});

function loadJobs() {
    console.log('Loading jobs...');
    $.ajax({
        url: '/job-orders/api/jobs',
        method: 'GET',
        success: function(response) {
            console.log('Jobs response:', response);
            console.log('Number of jobs:', response.jobs ? response.jobs.length : 0);
            if (response.success) {
                renderJobsTable(response.jobs);
            } else {
                console.error('Response not successful:', response);
                showToast('Failed to load jobs', 'danger');
            }
        },
        error: function(xhr) {
            console.error('AJAX error:', xhr);
            showToast('Failed to load jobs', 'danger');
        }
    });
}

function renderJobsTable(jobs) {
    console.log('Rendering jobs table with', jobs.length, 'jobs');
    const tbody = $('#jobsTableBody');
    tbody.empty();

    if (!jobs || jobs.length === 0) {
        console.log('No jobs to display');
        tbody.append(`
            <tr>
                <td colspan="6" class="text-center text-muted">No job orders yet. Click "Add Job" to create one.</td>
            </tr>
        `);
        return;
    }

    jobs.forEach((job, index) => {
        console.log(`Rendering job ${index}:`, job);
        const icon = job.job_type === 'follow' ? 'fa-user-plus' :
                     job.job_type === 'like' ? 'fa-heart' : 'fa-comment';

        tbody.append(`
            <tr>
                <td>${job.id}</td>
                <td><i class="fas ${icon} me-2"></i>${job.job_name}</td>
                <td>${job.target}</td>
                <td><span class="progress-text">${job.total_completed} / ${job.to_deliver}</span></td>
                <td>${job.account_count}</td>
                <td>
                    <button class="btn btn-sm btn-warning action-btn" onclick="editJob('${job.id}')" title="Edit">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-info action-btn" onclick="viewAccounts('${job.id}')" title="View Accounts">
                        <i class="fas fa-users"></i>
                    </button>
                    <button class="btn btn-sm btn-danger action-btn" onclick="deleteJob('${job.id}')" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `);
    });
    console.log('Jobs table rendered successfully');
}

function loadAvailableAccounts() {
    $.ajax({
        url: '/job-orders/api/available-accounts',
        method: 'GET',
        success: function(response) {
            if (response.success) {
                availableAccounts = response.accounts;
            }
        }
    });
}

function showJobTypeModal() {
    const modal = new bootstrap.Modal(document.getElementById('jobTypeModal'));
    modal.show();
}

function selectJobType(type) {
    // Hide job type modal
    const jobTypeModal = bootstrap.Modal.getInstance(document.getElementById('jobTypeModal'));
    jobTypeModal.hide();

    currentJobData = { job_type: type };

    // Show appropriate form modal
    setTimeout(() => {
        if (type === 'follow') {
            const modal = new bootstrap.Modal(document.getElementById('followJobModal'));
            modal.show();
        } else if (type === 'like') {
            const modal = new bootstrap.Modal(document.getElementById('likeJobModal'));
            modal.show();
        } else if (type === 'comment') {
            const modal = new bootstrap.Modal(document.getElementById('commentJobModal'));
            modal.show();
        }
    }, 300);
}

function saveFollowJob() {
    currentJobData.job_name = $('#follow_job_name').val();
    currentJobData.target = $('#follow_target').val();
    currentJobData.total_to_deliver = parseInt($('#follow_total').val());
    currentJobData.limit_per_hour = parseInt($('#follow_per_hour').val());
    currentJobData.limit_per_day = parseInt($('#follow_per_day').val());

    if (!currentJobData.target) {
        showToast('Please enter a target username', 'warning');
        return;
    }

    // Generate temp ID
    tempJobId = 'temp_' + Date.now();

    // Hide follow modal and show account selection
    const followModal = bootstrap.Modal.getInstance(document.getElementById('followJobModal'));
    followModal.hide();

    setTimeout(() => showAccountSelection(), 300);
}

function saveLikeJob() {
    currentJobData.job_name = $('#like_job_name').val();
    currentJobData.target = $('#like_target').val();
    currentJobData.total_to_deliver = parseInt($('#like_total').val());
    currentJobData.limit_per_hour = parseInt($('#like_per_hour').val());
    currentJobData.limit_per_day = parseInt($('#like_per_day').val());

    if (!currentJobData.target) {
        showToast('Please enter a target post URL', 'warning');
        return;
    }

    tempJobId = 'temp_' + Date.now();

    const likeModal = bootstrap.Modal.getInstance(document.getElementById('likeJobModal'));
    likeModal.hide();

    setTimeout(() => showAccountSelection(), 300);
}

function saveCommentJob() {
    currentJobData.job_name = $('#comment_job_name').val();
    currentJobData.target = $('#comment_target').val();
    currentJobData.total_to_deliver = parseInt($('#comment_total').val());
    currentJobData.limit_per_hour = parseInt($('#comment_per_hour').val());
    currentJobData.limit_per_day = parseInt($('#comment_per_day').val());
    currentJobData.comment_text = $('#comment_text').val();

    if (!currentJobData.target) {
        showToast('Please enter a target post URL', 'warning');
        return;
    }

    tempJobId = 'temp_' + Date.now();

    const commentModal = bootstrap.Modal.getInstance(document.getElementById('commentJobModal'));
    commentModal.hide();

    setTimeout(() => showAccountSelection(), 300);
}

function showAccountSelection() {
    // Update summary
    $('#summary_job_id').val('(New Job)');
    $('#summary_job_name').val(currentJobData.job_name);
    $('#summary_target').val(currentJobData.target);
    $('#totalOrders').text(currentJobData.total_to_deliver);
    $('#maxAccounts').text(currentJobData.total_to_deliver);
    $('#jobTypeText').text(currentJobData.job_type);

    // Render accounts
    renderAccountsList();

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('selectAccountsModal'));
    modal.show();
}

function renderAccountsList(filterText = '') {
    const tbody = $('#accountsTableBody');
    tbody.empty();

    let filtered = availableAccounts;
    if (filterText) {
        filtered = availableAccounts.filter(acc =>
            acc.username.toLowerCase().includes(filterText.toLowerCase()) ||
            acc.device.toLowerCase().includes(filterText.toLowerCase())
        );
    }

    filtered.forEach((account, index) => {
        tbody.append(`
            <tr>
                <td>
                    <input type="checkbox" class="account-checkbox"
                           data-device="${account.device}"
                           data-username="${account.username}"
                           onchange="updateSelectedCount()">
                </td>
                <td>${account.device}</td>
                <td>${account.username}</td>
            </tr>
        `);
    });

    updateSelectedCount();
}

function filterAccounts(searchText) {
    renderAccountsList(searchText);
}

function toggleSelectAll() {
    const checked = $('#selectAllAccounts').is(':checked');
    $('.account-checkbox').prop('checked', checked);
    updateSelectedCount();
}

function updateSelectedCount() {
    const count = $('.account-checkbox:checked').length;
    $('#selectedCount').text(count);
}

function saveJobWithAccounts() {
    // Collect selected accounts
    const selectedAccounts = [];
    $('.account-checkbox:checked').each(function() {
        selectedAccounts.push({
            device: $(this).data('device'),
            username: $(this).data('username')
        });
    });

    if (selectedAccounts.length === 0) {
        showToast('Please select at least one account', 'warning');
        return;
    }

    currentJobData.accounts = selectedAccounts;

    // Save job
    $.ajax({
        url: '/job-orders/api/jobs',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(currentJobData),
        success: function(response) {
            if (response.success) {
                showToast('Job order created successfully', 'success');

                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('selectAccountsModal'));
                modal.hide();

                // Reload jobs
                loadJobs();

                // Reset form
                currentJobData = {};
                tempJobId = null;
            } else {
                showToast('Failed to create job: ' + response.error, 'danger');
            }
        },
        error: function(xhr) {
            showToast('Failed to create job', 'danger');
        }
    });
}

function editJob(jobId) {
    // Load job data and show edit modal
    showToast('Edit functionality coming soon', 'info');
}

function viewAccounts(jobId) {
    // Show accounts assigned to this job
    showToast('View accounts functionality coming soon', 'info');
}

function deleteJob(jobId) {
    if (!confirm('Are you sure you want to delete this job order?')) {
        return;
    }

    $.ajax({
        url: `/job-orders/api/jobs/${jobId}`,
        method: 'DELETE',
        success: function(response) {
            if (response.success) {
                showToast('Job deleted successfully', 'success');
                loadJobs();
            } else {
                showToast('Failed to delete job: ' + response.error, 'danger');
            }
        },
        error: function(xhr) {
            showToast('Failed to delete job', 'danger');
        }
    });
}

function showToast(message, type = 'info') {
    const toast = $('#jobToast');
    const toastBody = $('#toastMessage');

    toast.removeClass('bg-success bg-danger bg-warning bg-info');
    toast.addClass('bg-' + type);
    toastBody.text(message);

    const bsToast = new bootstrap.Toast(toast[0]);
    bsToast.show();
}
</script>
{% endblock %}
