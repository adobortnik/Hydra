{% extends "base.html" %}
{% block title %}Settings - Hydra Dashboard{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6 col-lg-5">
        <div class="card shadow-sm">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0"><i class="fas fa-key me-2"></i>Change Dashboard Password</h5>
            </div>
            <div class="card-body">
                <div id="alertBox" class="d-none"></div>
                <form id="changePasswordForm">
                    <div class="mb-3">
                        <label for="currentPassword" class="form-label">Current Password</label>
                        <input type="password" class="form-control" id="currentPassword" required>
                    </div>
                    <div class="mb-3">
                        <label for="newPassword" class="form-label">New Password</label>
                        <input type="password" class="form-control" id="newPassword" required minlength="6">
                        <div class="form-text">Minimum 6 characters.</div>
                    </div>
                    <div class="mb-3">
                        <label for="confirmPassword" class="form-label">Confirm New Password</label>
                        <input type="password" class="form-control" id="confirmPassword" required minlength="6">
                    </div>
                    <button type="submit" class="btn btn-primary w-100" id="submitBtn">
                        <i class="fas fa-save me-1"></i> Change Password
                    </button>
                </form>
            </div>
        </div>
        <div class="card shadow-sm mt-3">
            <div class="card-body text-muted small">
                <p class="mb-1"><strong>Note:</strong> After changing the password, you will need to log in again with the new credentials.</p>
                <p class="mb-0">Default username: <code>admin</code></p>
            </div>
        </div>

        <!-- API Keys Section -->
        <div class="card shadow-sm mt-4">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0"><i class="fas fa-robot me-2"></i>AI Configuration</h5>
            </div>
            <div class="card-body">
                <div id="aiAlertBox" class="d-none"></div>
                <form id="aiSettingsForm">
                    <div class="mb-3">
                        <label for="openaiKey" class="form-label">OpenAI API Key</label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="openaiKey" placeholder="sk-...">
                            <button class="btn btn-outline-secondary" type="button" onclick="toggleKeyVisibility('openaiKey', this)">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div class="form-text">Used for AI caption generation in Content Schedule. Get yours at <a href="https://platform.openai.com/api-keys" target="_blank">platform.openai.com</a></div>
                    </div>
                    <div class="mb-3">
                        <label for="anthropicKey" class="form-label">Anthropic API Key <span class="text-muted">(optional)</span></label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="anthropicKey" placeholder="sk-ant-...">
                            <button class="btn btn-outline-secondary" type="button" onclick="toggleKeyVisibility('anthropicKey', this)">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div class="form-text">For future AI features.</div>
                    </div>
                    <div class="mb-3">
                        <label for="aiProvider" class="form-label">AI Provider</label>
                        <select class="form-select" id="aiProvider">
                            <option value="openai">OpenAI (gpt-4o-mini)</option>
                            <option value="anthropic">Anthropic (Claude)</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary w-100" id="saveAiBtn">
                        <i class="fas fa-save me-1"></i> Save AI Settings
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// ---- AI Settings ----
function toggleKeyVisibility(inputId, btn) {
    const input = document.getElementById(inputId);
    if (input.type === 'password') {
        input.type = 'text';
        btn.innerHTML = '<i class="fas fa-eye-slash"></i>';
    } else {
        input.type = 'password';
        btn.innerHTML = '<i class="fas fa-eye"></i>';
    }
}

// Load AI settings on page load
(async function loadAiSettings() {
    try {
        const resp = await fetch('/api/settings/ai');
        if (resp.ok) {
            const data = await resp.json();
            document.getElementById('openaiKey').value = data.openai_api_key || '';
            document.getElementById('anthropicKey').value = data.anthropic_api_key || '';
            document.getElementById('aiProvider').value = data.provider || 'openai';
        }
    } catch(e) { console.error('Failed to load AI settings', e); }
})();

document.getElementById('aiSettingsForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const alertBox = document.getElementById('aiAlertBox');
    const btn = document.getElementById('saveAiBtn');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Saving...';

    try {
        const resp = await fetch('/api/settings/ai', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                openai_api_key: document.getElementById('openaiKey').value.trim(),
                anthropic_api_key: document.getElementById('anthropicKey').value.trim(),
                provider: document.getElementById('aiProvider').value
            })
        });
        const result = await resp.json();
        if (resp.ok) {
            alertBox.className = 'alert alert-success';
            alertBox.textContent = 'AI settings saved successfully.';
        } else {
            alertBox.className = 'alert alert-danger';
            alertBox.textContent = result.error || 'Failed to save.';
        }
    } catch(err) {
        alertBox.className = 'alert alert-danger';
        alertBox.textContent = 'Network error: ' + err.message;
    } finally {
        alertBox.classList.remove('d-none');
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-save me-1"></i> Save AI Settings';
    }
});

// ---- Password ----
document.getElementById('changePasswordForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const alertBox = document.getElementById('alertBox');
    const currentPassword = document.getElementById('currentPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;

    if (newPassword !== confirmPassword) {
        alertBox.className = 'alert alert-danger';
        alertBox.textContent = 'New passwords do not match.';
        alertBox.classList.remove('d-none');
        return;
    }

    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Saving...';

    try {
        const resp = await fetch('/api/auth/change-password', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                current_password: currentPassword,
                new_password: newPassword
            })
        });
        const result = await resp.json();
        if (resp.ok) {
            alertBox.className = 'alert alert-success';
            alertBox.textContent = result.message + ' You will be prompted to log in again.';
            alertBox.classList.remove('d-none');
            document.getElementById('changePasswordForm').reset();
            // Force re-auth by reloading after a short delay
            setTimeout(function() {
                // Clear cached credentials by navigating to a URL with wrong creds
                window.location.reload();
            }, 2000);
        } else {
            alertBox.className = 'alert alert-danger';
            alertBox.textContent = result.error || 'Failed to change password.';
            alertBox.classList.remove('d-none');
        }
    } catch (err) {
        alertBox.className = 'alert alert-danger';
        alertBox.textContent = 'Network error: ' + err.message;
        alertBox.classList.remove('d-none');
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-save me-1"></i> Change Password';
    }
});
</script>
{% endblock %}
