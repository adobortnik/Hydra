{% extends 'base.html' %}

{% block title %}Manage Sources - Hydra{% endblock %}

{% block extra_css %}
<style>
    .account-card {
        margin-bottom: 10px;
        border-left: 4px solid #6c757d;
        transition: all 0.2s ease;
        background-color: #343a40;
    }
    .account-card.selected {
        border-left: 4px solid #0d6efd;
        background-color: rgba(13, 110, 253, 0.15);
    }
    .account-card:hover {
        cursor: pointer;
        background-color: #3a4147;
        transform: translateY(-1px);
    }
    .account-card.selected:hover {
        background-color: rgba(13, 110, 253, 0.25);
    }
    .usernames-editor {
        min-height: 300px;
        font-family: monospace;
        border-color: #495057;
        background-color: #343a40;
        color: #f8f9fa;
    }
    .usernames-editor:focus {
        border-color: #86b7fe;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        background-color: #343a40;
        color: #f8f9fa;
    }
    .form-control {
        background-color: #343a40;
        border-color: #495057;
        color: #f8f9fa;
    }
    .form-control:focus {
        background-color: #343a40;
        color: #f8f9fa;
    }
    .input-group-text {
        background-color: #343a40;
        border-color: #495057;
        color: #f8f9fa;
    }
    .status-badge {
        font-size: 0.8rem;
        padding: 0.25em 0.6em;
        border-radius: 10px;
    }
    .search-box {
        margin-bottom: 15px;
    }
    .select-all-container {
        margin-bottom: 15px;
    }
    .card {
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        border: none;
        background-color: #2c3034;
        margin-bottom: 20px;
    }
    .card-header {
        background-color: #343a40;
        border-bottom: 1px solid #444;
        font-weight: 600;
        color: #f8f9fa;
    }
    .card-body {
        color: #f8f9fa;
    }
    .card-footer {
        background-color: #343a40;
        border-top: 1px solid #444;
    }
    .accounts-container {
        max-height: 500px;
        overflow-y: auto;
    }
    textarea {
        background-color: #343a40;
        color: #f8f9fa;
        border-color: #495057;
    }
    #sourcesTabs {
        flex-wrap: wrap;
    }
    #sourcesTabs .nav-link {
        font-size: 0.9rem;
        padding: 0.5rem 0.8rem;
    }
    #sourcesTabs .nav-link.active {
        background-color: #0d6efd !important;
        color: #fff !important;
        border-color: #0d6efd !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <h1 class="mt-4 text-light">Manage Sources</h1>
    <ol class="breadcrumb mb-4">
        <li class="breadcrumb-item"><a href="/" class="text-light">Dashboard</a></li>
        <li class="breadcrumb-item active text-light">Manage Sources</li>
    </ol>

    <!-- Dynamic tab navigation (populated by JS) -->
    <ul class="nav nav-tabs mb-4" id="sourcesTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link bg-dark text-light border-secondary disabled" type="button">
                <span class="spinner-border spinner-border-sm me-1" role="status"></span> Loading types...
            </button>
        </li>
    </ul>

    <!-- Tab content: single pane reused for all source types -->
    <div class="tab-content" id="sourcesTabContent">

        <!-- Source type pane (dynamically loaded) -->
        <div class="tab-pane fade show active" id="source-tab-pane" role="tabpanel" tabindex="0">
            <div class="alert alert-info" id="sourceDescription">
                <i class="fas fa-info-circle me-2"></i> Select a source type above to manage usernames for your accounts.
            </div>

            <div class="row">
                <!-- Accounts list -->
                <div class="col-md-5">
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-user-circle me-2"></i>Accounts</h5>
                        </div>
                        <div class="card-body">
                            <div class="search-box">
                                <div class="input-group">
                                    <span class="input-group-text bg-dark border-secondary">
                                        <i class="fas fa-search"></i>
                                    </span>
                                    <input type="text" class="form-control bg-dark text-white border-secondary" id="accountSearch" placeholder="Search accounts...">
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="deviceSelect" class="form-label">Filter by Device:</label>
                                <select class="form-select bg-dark text-white border-secondary" id="deviceSelect" multiple size="3">
                                </select>
                                <small class="text-white-50">Hold Ctrl/Cmd to select multiple devices</small>
                            </div>
                            <div class="mb-3">
                                <label for="tagSelect" class="form-label">Filter by Tag:</label>
                                <select class="form-select bg-dark text-white border-secondary" id="tagSelect" multiple size="3">
                                </select>
                                <small class="text-white-50">Hold Ctrl/Cmd to select multiple tags</small>
                            </div>
                            <div class="mb-2">
                                <button class="btn btn-sm btn-outline-secondary w-100" id="clearFiltersBtn">
                                    <i class="fas fa-filter-circle-xmark me-1"></i> Clear Filters
                                </button>
                            </div>
                            <div class="select-all-container">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="selectAllAccounts">
                                    <label class="form-check-label" for="selectAllAccounts">
                                        <strong>Select All Accounts</strong>
                                    </label>
                                </div>
                            </div>
                            <div id="accountsList" class="accounts-container">
                                <div class="text-center py-5 text-white-50">
                                    <i class="fas fa-arrow-up fa-2x mb-2"></i>
                                    <p>Select a source type to load accounts</p>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer d-flex align-items-center border-secondary">
                            <span id="selectedCount" class="badge bg-primary rounded-pill me-2">0</span> accounts selected
                        </div>
                    </div>
                </div>

                <!-- Usernames editor -->
                <div class="col-md-7">
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-at me-2"></i><span id="editorTitle">Usernames</span></h5>
                        </div>
                        <div class="card-body">
                            <p class="text-white-50"><i class="fas fa-info-circle me-1"></i> <span id="editorHelp">Enter one username per line. These will be written to the source file for each selected account.</span></p>
                            <textarea id="usernamesEditor" class="form-control bg-dark text-white border-secondary" rows="12" placeholder="Enter usernames here, one per line
Example:
emmetcharm
noahcavill
username3
..."></textarea>
                        </div>
                        <div class="card-footer d-flex border-secondary">
                            <button id="updateSourcesBtn" class="btn btn-primary me-2" disabled>
                                <i class="fas fa-save me-1"></i> Update Sources
                            </button>
                            <button id="clearSelectionBtn" class="btn btn-outline-secondary">
                                <i class="fas fa-times-circle me-1"></i> Clear Selection
                            </button>
                        </div>
                    </div>

                    <div class="mt-3" id="updateResultsContainer" style="display: none;">
                        <div class="card">
                            <div class="card-header bg-success text-white d-flex align-items-center">
                                <i class="fas fa-check-circle me-2"></i>
                                <h5 class="mb-0">Update Results</h5>
                            </div>
                            <div class="card-body" id="updateResults">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bulk Settings Tab -->
        <div class="tab-pane fade" id="settings-tab-pane" role="tabpanel" aria-labelledby="settings-tab" tabindex="0">
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i> Update account settings in bulk. These settings affect how your Instagram accounts interact with posts and stories.
            </div>

            <div class="row">
                <!-- Accounts list for Settings -->
                <div class="col-md-5">
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-user-circle me-2"></i>Accounts</h5>
                        </div>
                        <div class="card-body">
                            <div class="search-box">
                                <div class="input-group">
                                    <span class="input-group-text bg-dark border-secondary">
                                        <i class="fas fa-search"></i>
                                    </span>
                                    <input type="text" class="form-control bg-dark text-white border-secondary" id="settingsAccountSearch" placeholder="Search accounts...">
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="settingsDeviceSelect" class="form-label">Filter by Device:</label>
                                <select class="form-select bg-dark text-white border-secondary" id="settingsDeviceSelect" multiple size="3">
                                </select>
                                <small class="text-white-50">Hold Ctrl/Cmd to select multiple devices</small>
                            </div>
                            <div class="mb-3">
                                <label for="settingsTagSelect" class="form-label">Filter by Tag:</label>
                                <select class="form-select bg-dark text-white border-secondary" id="settingsTagSelect" multiple size="3">
                                </select>
                                <small class="text-white-50">Hold Ctrl/Cmd to select multiple tags</small>
                            </div>
                            <div class="mb-2">
                                <button class="btn btn-sm btn-outline-secondary w-100" id="settingsClearFiltersBtn">
                                    <i class="fas fa-filter-circle-xmark me-1"></i> Clear Filters
                                </button>
                            </div>
                            <div class="select-all-container">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="settingsSelectAllAccounts">
                                    <label class="form-check-label" for="settingsSelectAllAccounts">
                                        <strong>Select All Accounts</strong>
                                    </label>
                                </div>
                            </div>
                            <div id="settingsAccountsList" class="accounts-container">
                                <div class="text-center py-5">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2">Loading accounts...</p>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer d-flex align-items-center border-secondary">
                            <span id="settingsSelectedCount" class="badge bg-primary rounded-pill me-2">0</span> accounts selected
                        </div>
                    </div>
                </div>

                <!-- Settings editor -->
                <div class="col-md-7">
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-cogs me-2"></i>Account Settings</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-4">
                                <h6 class="text-light mb-3">Mention Settings</h6>
                                <div class="mb-3">
                                    <label for="sharepostMention" class="form-label">Share Post Mention Username</label>
                                    <input type="text" class="form-control bg-dark text-white border-secondary" id="sharepostMention" placeholder="@username">
                                    <small class="text-white-50">Username to mention when sharing posts</small>
                                </div>
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="enableMentionToStory">
                                    <label class="form-check-label" for="enableMentionToStory">Enable Mention to Story</label>
                                    <div class="text-muted small">When enabled, the bot will mention users in stories</div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <h6 class="text-light mb-3">Post Type Settings</h6>
                                <div class="form-group">
                                    <label for="postTypeToShare" class="form-label">Post Type to Share</label>
                                    <select class="form-select bg-dark text-white border-secondary" id="postTypeToShare">
                                        <option value="post_reels">Reels Only</option>
                                        <option value="post_photos">Photos Only</option>
                                        <option value="post_all">Both Reels and Photos</option>
                                    </select>
                                    <small class="text-white-50">Select which type of posts to share</small>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer d-flex border-secondary">
                            <button id="updateSettingsBtn" class="btn btn-primary me-2" disabled>
                                <i class="fas fa-save me-1"></i> Update Settings
                            </button>
                            <button id="settingsClearSelectionBtn" class="btn btn-outline-secondary">
                                <i class="fas fa-times-circle me-1"></i> Clear Selection
                            </button>
                        </div>
                    </div>

                    <div class="mt-3" id="settingsUpdateResultsContainer" style="display: none;">
                        <div class="card">
                            <div class="card-header bg-success text-white d-flex align-items-center">
                                <i class="fas fa-check-circle me-2"></i>
                                <h5 class="mb-0">Update Results</h5>
                            </div>
                            <div class="card-body" id="settingsUpdateResults">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="/static/js/device_selection.js"></script>
<script>
(function() {
    // ─── Utility helpers ───────────────────────────────────────────────

    function extractUsernameFromInstagramUrl(url) {
        if (!url.includes('instagram.com/')) return url;
        const m = url.match(/instagram\.com\/([^/?#]+)/);
        return m ? m[1] : url;
    }

    // Cache device names from /api/devices
    let _deviceNameMap = null;
    async function getDeviceNameMap() {
        if (_deviceNameMap) return _deviceNameMap;
        try {
            const r = await fetch('/api/devices');
            const devices = await r.json();
            _deviceNameMap = {};
            devices.forEach(d => {
                const serial = d.device_serial || d.deviceid || '';
                const name = d.device_name || d.devicename || '';
                if (serial) _deviceNameMap[serial] = name;
            });
        } catch(e) { _deviceNameMap = {}; }
        return _deviceNameMap;
    }

    async function populateDeviceDropdown(selectEl, accounts) {
        if (!selectEl || !accounts || !accounts.length) return;
        const nameMap = await getDeviceNameMap();
        const ids = [...new Set(accounts.map(a => a.device_id))].sort();
        selectEl.innerHTML = '';
        ids.forEach(id => {
            const o = document.createElement('option');
            o.value = id;
            const name = nameMap[id];
            o.textContent = name ? `${name} (${id})` : id;
            selectEl.appendChild(o);
        });
    }

    async function populateTagDropdown(selectEl) {
        if (!selectEl) return;
        try {
            const r = await fetch('/api/profile_automation/tags');
            if (!r.ok) throw new Error('Failed to load tags');
            const tags = await r.json();
            selectEl.innerHTML = '';
            tags.forEach(t => {
                const o = document.createElement('option');
                o.value = t.name;
                o.textContent = t.name;
                selectEl.appendChild(o);
            });
        } catch (e) {
            console.error('Error loading tags:', e);
        }
    }

    function applyFilters(accounts, deviceSelect, tagSelect, search) {
        let f = [...accounts];
        const devs = Array.from(deviceSelect.selectedOptions).map(o => o.value);
        const tags = Array.from(tagSelect.selectedOptions).map(o => o.value);
        if (devs.length) f = f.filter(a => devs.includes(a.device_id));
        if (tags.length) f = f.filter(a => a.tags && a.tags.some(t => tags.includes(t)));
        if (search) {
            const s = search.toLowerCase();
            f = f.filter(a => a.account_name.toLowerCase().includes(s) || a.device_id.toLowerCase().includes(s));
        }
        return f;
    }

    // ─── Icon map for source types ─────────────────────────────────────
    const ICON_MAP = {
        follow: 'fa-user-plus',
        follow_likers: 'fa-heart',
        follow_specific: 'fa-crosshairs',
        share: 'fa-share-alt',
        share_to_story: 'fa-book-open',
        dm: 'fa-envelope',
        story_viewer_followers: 'fa-eye',
        story_viewer_likers: 'fa-eye',
        like_specific: 'fa-thumbs-up',
        like: 'fa-thumbs-up',
        view_specific: 'fa-binoculars',
        comment: 'fa-comment',
        reels: 'fa-film',
        whitelist: 'fa-list-check'
    };

    // ─── Source-tab state (shared single pane) ─────────────────────────
    let currentSourceType = null;   // key of the active source type
    let currentSourceLabel = '';
    let currentSourceFilename = '';
    let allAccounts = [];
    let filteredAccounts = [];
    let selectedAccounts = new Set();
    let currentSearch = '';

    // DOM refs for the shared source pane
    const $desc         = document.getElementById('sourceDescription');
    const $editorTitle  = document.getElementById('editorTitle');
    const $editorHelp   = document.getElementById('editorHelp');
    const $accountsList = document.getElementById('accountsList');
    const $search       = document.getElementById('accountSearch');
    const $deviceSel    = document.getElementById('deviceSelect');
    const $tagSel       = document.getElementById('tagSelect');
    const $clearFilters = document.getElementById('clearFiltersBtn');
    const $selectAll    = document.getElementById('selectAllAccounts');
    const $countBadge   = document.getElementById('selectedCount');
    const $editor       = document.getElementById('usernamesEditor');
    const $updateBtn    = document.getElementById('updateSourcesBtn');
    const $clearSelBtn  = document.getElementById('clearSelectionBtn');
    const $resultsCont  = document.getElementById('updateResultsContainer');
    const $results      = document.getElementById('updateResults');

    // ─── Render / interaction for the shared source pane ───────────────

    function renderAccounts() {
        if (!filteredAccounts.length) {
            $accountsList.innerHTML = '<div class="alert alert-warning"><i class="fas fa-exclamation-circle"></i> No accounts found matching your search.</div>';
            updateCount();
            return;
        }
        $accountsList.innerHTML = filteredAccounts.map(a => {
            const id = `${a.device_id}/${a.account_name}`;
            const sel = selectedAccounts.has(id);
            return `
                <div class="card account-card ${sel ? 'selected' : ''}" data-id="${id}">
                    <div class="card-body py-2">
                        <div class="form-check">
                            <input class="form-check-input acct-cb" type="checkbox" ${sel ? 'checked' : ''}>
                            <label class="form-check-label">
                                <strong>${a.account_name}</strong>
                                <small class="text-white-50">@${(_deviceNameMap && _deviceNameMap[a.device_id]) || a.device_id}</small>
                            </label>
                        </div>
                        <div>
                            ${a.sources_exists
                                ? `<span class="badge bg-success status-badge">${a.file_name} exists</span>
                                   <span class="badge bg-info status-badge">${a.usernames_count} usernames</span>`
                                : `<span class="badge bg-warning status-badge">no ${a.file_name}</span>`}
                        </div>
                    </div>
                </div>`;
        }).join('');

        // Card click
        $accountsList.querySelectorAll('.account-card').forEach(card => {
            card.addEventListener('click', function(e) {
                if (e.target.type === 'checkbox') return;
                toggleAccount(this);
            });
        });
        // Checkbox change
        $accountsList.querySelectorAll('.acct-cb').forEach(cb => {
            cb.addEventListener('change', function() {
                toggleAccount(this.closest('.account-card'));
            });
        });
        updateCount();
    }

    function toggleAccount(card) {
        const id = card.dataset.id;
        const cb = card.querySelector('.acct-cb');
        if (selectedAccounts.has(id)) {
            selectedAccounts.delete(id);
            card.classList.remove('selected');
            cb.checked = false;
        } else {
            selectedAccounts.add(id);
            card.classList.add('selected');
            cb.checked = true;
        }
        updateCount();
    }

    function updateCount() {
        $countBadge.textContent = selectedAccounts.size;
        $updateBtn.disabled = selectedAccounts.size === 0 || !$editor.value.trim();
    }

    function doFilter() {
        filteredAccounts = applyFilters(allAccounts, $deviceSel, $tagSel, currentSearch);
        renderAccounts();
    }

    // Wire shared-pane events once
    $search.addEventListener('input', function() { currentSearch = this.value; doFilter(); });
    $deviceSel.addEventListener('change', doFilter);
    $tagSel.addEventListener('change', doFilter);
    $clearFilters.addEventListener('click', function() {
        $search.value = ''; currentSearch = '';
        $deviceSel.selectedIndex = -1;
        $tagSel.selectedIndex = -1;
        doFilter();
    });
    $selectAll.addEventListener('change', function() {
        filteredAccounts.forEach(a => {
            const id = `${a.device_id}/${a.account_name}`;
            this.checked ? selectedAccounts.add(id) : selectedAccounts.delete(id);
        });
        renderAccounts();
    });
    $editor.addEventListener('input', updateCount);
    $clearSelBtn.addEventListener('click', function() {
        selectedAccounts.clear();
        $selectAll.checked = false;
        renderAccounts();
    });

    // Update button
    $updateBtn.addEventListener('click', async function() {
        if (!selectedAccounts.size || !$editor.value.trim() || !currentSourceType) return;
        this.disabled = true;
        this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Updating...';

        try {
            const resp = await fetch('/api/sources/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    account_ids: Array.from(selectedAccounts),
                    usernames: $editor.value.split('\n').map(l => l.trim()).filter(Boolean).map(extractUsernameFromInstagramUrl).join('\n'),
                    source_type: currentSourceType
                })
            });
            if (!resp.ok) throw new Error('Failed to update sources');
            const result = await resp.json();

            $resultsCont.style.display = 'block';
            $resultsCont.querySelector('.card-header').className = result.success
                ? 'card-header bg-success text-white d-flex align-items-center'
                : 'card-header bg-danger text-white d-flex align-items-center';

            let html = `<p>${result.message}</p>`;
            if (result.failed_accounts && result.failed_accounts.length) {
                html += `<div class="alert alert-warning"><h6>Failed to update ${result.failed_accounts.length} accounts:</h6><ul>${result.failed_accounts.map(a => `<li>${a.account_id}: ${a.error}</li>`).join('')}</ul></div>`;
            }
            $results.innerHTML = html;
            loadSourceAccounts(currentSourceType);
        } catch (err) {
            $resultsCont.style.display = 'block';
            $resultsCont.querySelector('.card-header').className = 'card-header bg-danger text-white d-flex align-items-center';
            $results.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> ${err.message}</div>`;
        } finally {
            this.disabled = false;
            this.innerHTML = `<i class="fas fa-save me-1"></i> Update ${currentSourceLabel}`;
        }
    });

    // ─── Load accounts for a given source type ─────────────────────────

    async function loadSourceAccounts(sourceType) {
        $accountsList.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2">Loading accounts...</p></div>';

        try {
            const r = await fetch(`/api/sources/accounts?source_type=${encodeURIComponent(sourceType)}`);
            if (!r.ok) throw new Error('Failed to load accounts');
            allAccounts = await r.json();
            filteredAccounts = [...allAccounts];
            renderAccounts();
            populateDeviceDropdown($deviceSel, allAccounts);
            await populateTagDropdown($tagSel);
        } catch (err) {
            $accountsList.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> ${err.message}</div>`;
        }
    }

    // ─── Switch source type ────────────────────────────────────────────

    function switchSourceType(key, label, filename) {
        currentSourceType = key;
        currentSourceLabel = label;
        currentSourceFilename = filename;

        // Reset state
        selectedAccounts.clear();
        currentSearch = '';
        $search.value = '';
        $selectAll.checked = false;
        $editor.value = '';
        $resultsCont.style.display = 'none';
        $deviceSel.selectedIndex = -1;
        $tagSel.selectedIndex = -1;

        // Update UI text
        const fileNote = filename ? ` (<strong>${filename}</strong>)` : '';
        $desc.innerHTML = `<i class="fas fa-info-circle me-2"></i> Manage the source files${fileNote} for multiple accounts at once. These files contain the usernames used by the <em>${label}</em> action.`;
        $editorTitle.textContent = label;
        $editorHelp.textContent = filename
            ? `Enter one username per line. These will be written to ${filename} for each selected account.`
            : `Enter one username per line. These will be written to the source file for each selected account.`;
        $updateBtn.innerHTML = `<i class="fas fa-save me-1"></i> Update ${label}`;

        // Show source pane, hide settings
        document.getElementById('source-tab-pane').classList.add('show', 'active');
        document.getElementById('settings-tab-pane').classList.remove('show', 'active');

        loadSourceAccounts(key);
    }

    // ─── Build tabs from API ───────────────────────────────────────────

    async function buildTabs() {
        const tabBar = document.getElementById('sourcesTabs');
        try {
            const r = await fetch('/api/sources/types');
            if (!r.ok) throw new Error('Failed to load source types');
            const types = await r.json();

            tabBar.innerHTML = '';

            types.forEach((t, i) => {
                const icon = ICON_MAP[t.key] || 'fa-file-lines';
                const li = document.createElement('li');
                li.className = 'nav-item';
                li.setAttribute('role', 'presentation');
                li.innerHTML = `<button class="nav-link bg-dark text-light border-secondary ${i === 0 ? 'active' : ''}" type="button" data-source-key="${t.key}" data-source-label="${t.label}" data-source-file="${t.filename || ''}"><i class="fas ${icon} me-1"></i>${t.label}</button>`;
                tabBar.appendChild(li);
            });

            // Bulk Settings tab (always last)
            const settingsLi = document.createElement('li');
            settingsLi.className = 'nav-item';
            settingsLi.setAttribute('role', 'presentation');
            settingsLi.innerHTML = '<button class="nav-link bg-dark text-light border-secondary" type="button" data-settings="1"><i class="fas fa-cogs me-1"></i>Bulk Settings</button>';
            tabBar.appendChild(settingsLi);

            // Wire tab clicks
            tabBar.querySelectorAll('button[data-source-key]').forEach(btn => {
                btn.addEventListener('click', function() {
                    tabBar.querySelectorAll('.nav-link').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    switchSourceType(this.dataset.sourceKey, this.dataset.sourceLabel, this.dataset.sourceFile);
                });
            });

            tabBar.querySelector('button[data-settings]').addEventListener('click', function() {
                tabBar.querySelectorAll('.nav-link').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                document.getElementById('source-tab-pane').classList.remove('show', 'active');
                document.getElementById('settings-tab-pane').classList.add('show', 'active');
                loadSettingsAccounts();
            });

            // Auto-select first type
            if (types.length) {
                switchSourceType(types[0].key, types[0].label, types[0].filename);
            }
        } catch (err) {
            tabBar.innerHTML = `<li class="nav-item"><span class="nav-link text-danger"><i class="fas fa-exclamation-triangle me-1"></i> ${err.message}</span></li>`;
        }
    }

    // ─── Bulk Settings tab (unchanged logic) ───────────────────────────

    function initSettingsTab() {
        const sList    = document.getElementById('settingsAccountsList');
        const sSearch  = document.getElementById('settingsAccountSearch');
        const sDevice  = document.getElementById('settingsDeviceSelect');
        const sTag     = document.getElementById('settingsTagSelect');
        const sClearF  = document.getElementById('settingsClearFiltersBtn');
        const sSelAll  = document.getElementById('settingsSelectAllAccounts');
        const sCount   = document.getElementById('settingsSelectedCount');
        const sUpdate  = document.getElementById('updateSettingsBtn');
        const sClearS  = document.getElementById('settingsClearSelectionBtn');
        const sResCont = document.getElementById('settingsUpdateResultsContainer');
        const sRes     = document.getElementById('settingsUpdateResults');
        const sMention = document.getElementById('sharepostMention');
        const sMentSt  = document.getElementById('enableMentionToStory');
        const sPostTyp = document.getElementById('postTypeToShare');

        let accts = [], filtered = [], selected = new Set(), search = '';

        function doFilter() { filtered = applyFilters(accts, sDevice, sTag, search); render(); }

        function render() {
            if (!filtered.length) {
                sList.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle me-2"></i>No accounts found.</div>';
                updCount(); return;
            }
            sList.innerHTML = filtered.map(a => {
                const id = `${a.device_id}/${a.account_name}`, sel = selected.has(id);
                return `<div class="account-card p-3 mb-2 ${sel?'selected':''}" data-account-id="${id}"><div class="d-flex justify-content-between align-items-center"><div><h6 class="mb-0">${a.account_name}</h6><small class="text-white-50">${a.device_id}</small></div><div class="form-check"><input class="form-check-input acct-cb-s" type="checkbox" ${sel?'checked':''}></div></div></div>`;
            }).join('');
            sList.querySelectorAll('.account-card').forEach(c => {
                c.addEventListener('click', function() {
                    const id = this.dataset.accountId, cb = this.querySelector('.acct-cb-s');
                    selected.has(id) ? (selected.delete(id), this.classList.remove('selected'), cb.checked=false) : (selected.add(id), this.classList.add('selected'), cb.checked=true);
                    updCount();
                });
            });
            updCount();
        }

        function updCount() { sCount.textContent = selected.size; sUpdate.disabled = !selected.size; }

        sSearch.addEventListener('input', function() { search = this.value; doFilter(); });
        sDevice.addEventListener('change', doFilter);
        sTag.addEventListener('change', doFilter);
        sClearF.addEventListener('click', function() { sSearch.value=''; search=''; sDevice.selectedIndex=-1; sTag.selectedIndex=-1; doFilter(); });
        sSelAll.addEventListener('change', function() { filtered.forEach(a => { const id=`${a.device_id}/${a.account_name}`; this.checked?selected.add(id):selected.delete(id); }); render(); });
        sClearS.addEventListener('click', function() { selected.clear(); render(); });

        sUpdate.addEventListener('click', async function() {
            if (!selected.size) return;
            this.disabled=true; this.innerHTML='<span class="spinner-border spinner-border-sm me-2"></span> Updating...';
            try {
                const body = { accounts: Array.from(selected).map(id => { const [d,n]=id.split('/'); return {device_id:d, account_name:n}; }), settings: { sharepost_mention: sMention.value, enable_mention_to_story: sMentSt.checked?'true':'false', post_type_to_share: sPostTyp.value } };
                const r = await fetch('/api/accounts/bulk-settings', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
                const res = await r.json();
                sResCont.style.display='block';
                if (r.ok) {
                    sResCont.querySelector('.card-header').className='card-header bg-success text-white d-flex align-items-center';
                    let h = `<div class="alert alert-success"><i class="fas fa-check-circle me-2"></i> Updated ${res.updated_accounts} accounts.</div>`;
                    if (res.failed_accounts&&res.failed_accounts.length) h += `<div class="alert alert-warning"><h6>Failed: ${res.failed_accounts.length}</h6><ul>${res.failed_accounts.map(a=>`<li>${a.account_id}: ${a.error}</li>`).join('')}</ul></div>`;
                    sRes.innerHTML = h;
                } else {
                    sResCont.querySelector('.card-header').className='card-header bg-danger text-white d-flex align-items-center';
                    sRes.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i> ${res.error||'Failed'}</div>`;
                }
            } catch(e) {
                sResCont.style.display='block'; sResCont.querySelector('.card-header').className='card-header bg-danger text-white d-flex align-items-center';
                sRes.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> ${e.message}</div>`;
            } finally { this.disabled=false; this.innerHTML='<i class="fas fa-save me-1"></i> Update Settings'; }
        });

        window.loadSettingsAccounts = async function() {
            sList.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary"></div><p class="mt-2">Loading accounts...</p></div>';
            try {
                const r = await fetch('/api/sources/accounts?source_type=follow');
                if (!r.ok) throw new Error('Failed');
                accts = await r.json(); filtered=[...accts]; render();
                populateDeviceDropdown(sDevice, accts);
                await populateTagDropdown(sTag);
            } catch(e) {
                sList.innerHTML = `<div class="alert alert-danger">${e.message}</div>`;
            }
        };
    }

    // ─── Init ──────────────────────────────────────────────────────────
    document.addEventListener('DOMContentLoaded', function() {
        initSettingsTab();
        buildTabs();
    });
})();
</script>
{% endblock %}
