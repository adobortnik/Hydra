{% extends "base.html" %}

{% block title %}Account Health Monitor{% endblock %}

{% block extra_css %}
<style>
    .health-card {
        background: #1a1d23;
        border: 1px solid #2d3139;
        border-radius: 12px;
        padding: 1.25rem;
        transition: transform .15s, box-shadow .15s;
        cursor: pointer;
    }
    .health-card:hover { transform: translateY(-2px); box-shadow: 0 4px 20px rgba(0,0,0,.3); }
    .health-card .card-value { font-size: 2.2rem; font-weight: 700; }
    .health-card .card-label { font-size: .85rem; color: #8b949e; text-transform: uppercase; letter-spacing: .5px; }

    .health-card.active   { border-left: 4px solid #28a745; }
    .health-card.warning   { border-left: 4px solid #ffc107; }
    .health-card.danger    { border-left: 4px solid #dc3545; }
    .health-card.muted     { border-left: 4px solid #6c757d; }

    .badge-health {
        padding: 4px 10px;
        border-radius: 6px;
        font-size: .78rem;
        font-weight: 600;
        letter-spacing: .3px;
    }
    .badge-active             { background: #28a74533; color: #28a745; }
    .badge-logged_out         { background: #6c757d33; color: #adb5bd; }
    .badge-suspended          { background: #dc354533; color: #dc3545; }
    .badge-verification_required { background: #ffc10733; color: #ffc107; }
    .badge-2fa_required       { background: #fd7e1433; color: #fd7e14; }
    .badge-action_blocked     { background: #dc354533; color: #e06070; }
    .badge-replaced           { background: #6c757d22; color: #6c757d; }

    .events-table th { font-size: .8rem; text-transform: uppercase; color: #8b949e; letter-spacing: .5px; border-color: #2d3139; }
    .events-table td { border-color: #2d3139; vertical-align: middle; }
    .events-table tr:hover { background: #1e2128; }

    .filter-btn { border-radius: 20px; padding: 4px 14px; font-size: .82rem; }
    .filter-btn.active { background: #0d6efd; color: white; }

    .detail-snippet {
        max-width: 300px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-size: .82rem;
        color: #8b949e;
    }
    .empty-state { text-align: center; padding: 3rem 1rem; color: #8b949e; }
    .empty-state i { font-size: 3rem; margin-bottom: 1rem; opacity: .5; }

    /* Replace modal */
    .replace-detail { background: #12151a; border-radius: 8px; padding: 1rem; margin-bottom: .75rem; }
    .replace-detail .label { font-size: .78rem; color: #8b949e; text-transform: uppercase; letter-spacing: .5px; }
    .replace-detail .value { font-size: 1rem; color: #e6e6e6; font-weight: 600; }
    .replace-arrow { font-size: 2rem; text-align: center; color: #0d6efd; margin: .5rem 0; }
    .replace-warning { background: #ffc10715; border: 1px solid #ffc10733; border-radius: 8px; padding: .75rem 1rem; font-size: .85rem; color: #ffc107; }

    /* Toast */
    .toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }
    .toast-msg {
        background: #28a745; color: white; padding: 12px 20px; border-radius: 8px;
        margin-bottom: 8px; font-weight: 500; box-shadow: 0 4px 12px rgba(0,0,0,.4);
        animation: slideIn .3s ease-out;
    }
    .toast-msg.error { background: #dc3545; }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-1 text-white">
                        <i class="fas fa-heartbeat me-2 text-danger"></i>Account Health Monitor
                    </h1>
                    <p class="text-white-50 mb-0">Track account issues, suspensions, and verification requirements</p>
                </div>
                <div>
                    <button id="btnResolveAll" class="btn btn-outline-secondary btn-sm me-2" onclick="resolveAllEvents()">
                        <i class="fas fa-check-double me-1"></i>Resolve All
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="loadData()">
                        <i class="fas fa-sync-alt me-1"></i>Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4" id="summaryCards">
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="health-card active" onclick="filterByType('')">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="card-value text-success" id="countActive">0</div>
                        <div class="card-label">üü¢ Active</div>
                    </div>
                    <i class="fas fa-check-circle fa-2x text-success" style="opacity:.4"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="health-card warning" onclick="filterByType('verification_required')">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="card-value text-warning" id="countWarning">0</div>
                        <div class="card-label">üü° Verification / 2FA</div>
                    </div>
                    <i class="fas fa-exclamation-triangle fa-2x text-warning" style="opacity:.4"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="health-card danger" onclick="filterByType('suspended')">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="card-value text-danger" id="countSuspended">0</div>
                        <div class="card-label">üî¥ Suspended</div>
                    </div>
                    <i class="fas fa-ban fa-2x text-danger" style="opacity:.4"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="health-card muted" onclick="filterByType('logged_out')">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="card-value text-secondary" id="countLoggedOut">0</div>
                        <div class="card-label">‚ö´ Logged Out</div>
                    </div>
                    <i class="fas fa-sign-out-alt fa-2x text-secondary" style="opacity:.4"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="d-flex gap-2 flex-wrap">
                <button class="btn btn-outline-light filter-btn active" data-type="" onclick="filterByType('', this)">All</button>
                <button class="btn btn-outline-warning filter-btn" data-type="verification_required" onclick="filterByType('verification_required', this)">Verification Required</button>
                <button class="btn btn-outline-warning filter-btn" data-type="2fa_required" onclick="filterByType('2fa_required', this)">2FA Required</button>
                <button class="btn btn-outline-danger filter-btn" data-type="suspended" onclick="filterByType('suspended', this)">Suspended</button>
                <button class="btn btn-outline-secondary filter-btn" data-type="logged_out" onclick="filterByType('logged_out', this)">Logged Out</button>
                <button class="btn btn-outline-danger filter-btn" data-type="action_blocked" onclick="filterByType('action_blocked', this)">Action Blocked</button>
            </div>
        </div>
    </div>

    <!-- Events Table -->
    <div class="row">
        <div class="col-12">
            <div class="card bg-dark border-secondary">
                <div class="card-header bg-dark border-secondary d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 text-white"><i class="fas fa-list me-2"></i>Flagged Accounts</h5>
                    <span class="text-muted" id="eventCount">0 events</span>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-dark events-table mb-0">
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    <th>Device</th>
                                    <th>Status</th>
                                    <th>Details</th>
                                    <th>Detected</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="eventsBody">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                    <div class="empty-state d-none" id="emptyState">
                        <i class="fas fa-heart"></i>
                        <p class="mb-0">All accounts are healthy! No flagged issues.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<!-- Replace Confirmation Modal -->
<div class="modal fade" id="replaceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header border-secondary">
                <h5 class="modal-title"><i class="fas fa-exchange-alt me-2 text-warning"></i>Replace Account</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="replaceModalBody">
                <div class="text-center py-3"><i class="fas fa-spinner fa-spin"></i> Loading...</div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" id="confirmReplaceBtn" onclick="confirmReplace()" disabled>
                    <i class="fas fa-exchange-alt me-1"></i>Replace Account
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Event Detail Modal -->
<div class="modal fade" id="eventDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header border-secondary">
                <h5 class="modal-title"><i class="fas fa-info-circle me-2"></i>Event Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="eventDetailBody">
                <!-- Populated by JS -->
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" id="modalResolveBtn" onclick="resolveFromModal()">
                    <i class="fas fa-check me-1"></i>Resolve
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let allEvents = [];
let currentFilter = '';
let currentModalEventId = null;

document.addEventListener('DOMContentLoaded', loadData);

function loadData() {
    Promise.all([
        fetch('/api/account-health').then(r => r.json()),
        fetch('/api/account-health/summary').then(r => r.json()),
    ]).then(([events, summary]) => {
        allEvents = events;
        updateSummaryCards(summary);
        renderEvents(allEvents);
    }).catch(err => {
        console.error('Failed to load health data:', err);
    });
}

function updateSummaryCards(summary) {
    const s = summary.accounts_by_status || {};
    const e = summary.events_by_type || {};

    document.getElementById('countActive').textContent = s.active || 0;
    document.getElementById('countWarning').textContent =
        (e.verification_required || 0) + (e['2fa_required'] || 0);
    document.getElementById('countSuspended').textContent =
        (e.suspended || 0) + (e.action_blocked || 0);
    document.getElementById('countLoggedOut').textContent = e.logged_out || 0;
}

function filterByType(type, btn) {
    currentFilter = type;

    // Update filter button styles
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    if (btn) {
        btn.classList.add('active');
    } else {
        document.querySelector('.filter-btn[data-type=""]').classList.add('active');
    }

    const filtered = type
        ? allEvents.filter(e => e.event_type === type)
        : allEvents;
    renderEvents(filtered);
}

function renderEvents(events) {
    const tbody = document.getElementById('eventsBody');
    const emptyState = document.getElementById('emptyState');
    document.getElementById('eventCount').textContent = events.length + ' events';

    if (events.length === 0) {
        tbody.innerHTML = '';
        emptyState.classList.remove('d-none');
        return;
    }

    emptyState.classList.add('d-none');
    tbody.innerHTML = events.map(e => `
        <tr>
            <td>
                <strong class="text-white">@${escHtml(e.username || '?')}</strong>
            </td>
            <td class="text-muted">${escHtml(e.device_name || e.device_serial || '-')}</td>
            <td>
                <span class="badge-health badge-${e.event_type}">
                    ${statusIcon(e.event_type)} ${formatStatus(e.event_type)}
                </span>
            </td>
            <td>
                <span class="detail-snippet" title="${escHtml(e.details || '')}">${escHtml(e.details || '-')}</span>
            </td>
            <td class="text-muted">${timeAgo(e.detected_at)}</td>
            <td>
                <button class="btn btn-sm btn-outline-warning me-1" onclick="showReplaceModal(${e.id})" title="Replace Account">
                    <i class="fas fa-exchange-alt"></i>
                </button>
                <button class="btn btn-sm btn-outline-success me-1" onclick="resolveEvent(${e.id})" title="Resolve">
                    <i class="fas fa-check"></i>
                </button>
                <button class="btn btn-sm btn-outline-info" onclick="showDetail(${e.id})" title="Details">
                    <i class="fas fa-eye"></i>
                </button>
            </td>
        </tr>
    `).join('');
}

function resolveEvent(eventId) {
    if (!confirm('Mark this event as resolved?')) return;

    fetch('/api/account-health/resolve', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ event_id: eventId, resolved_by: 'manual' }),
    }).then(r => r.json()).then(data => {
        if (data.success) loadData();
    });
}

function resolveAllEvents() {
    const type = currentFilter || null;
    const msg = type
        ? `Resolve all "${type}" events?`
        : 'Resolve ALL unresolved health events?';
    if (!confirm(msg)) return;

    fetch('/api/account-health/resolve-all', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ event_type: type || undefined }),
    }).then(r => r.json()).then(data => {
        if (data.success) loadData();
    });
}

function showDetail(eventId) {
    const event = allEvents.find(e => e.id === eventId);
    if (!event) return;

    currentModalEventId = eventId;
    const body = document.getElementById('eventDetailBody');
    body.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <p><strong>Username:</strong> @${escHtml(event.username || '?')}</p>
                <p><strong>Device:</strong> ${escHtml(event.device_name || event.device_serial || '-')}</p>
                <p><strong>Event Type:</strong>
                    <span class="badge-health badge-${event.event_type}">
                        ${statusIcon(event.event_type)} ${formatStatus(event.event_type)}
                    </span>
                </p>
            </div>
            <div class="col-md-6">
                <p><strong>Detected:</strong> ${event.detected_at || '-'}</p>
                <p><strong>Account Status:</strong> ${event.account_status || '-'}</p>
                <p><strong>Account ID:</strong> ${event.account_id}</p>
            </div>
        </div>
        <hr class="border-secondary">
        <p><strong>Details:</strong></p>
        <pre class="bg-black p-3 rounded" style="max-height:200px;overflow:auto;font-size:.82rem;">${escHtml(event.details || 'No details')}</pre>
    `;

    new bootstrap.Modal(document.getElementById('eventDetailModal')).show();
}

function resolveFromModal() {
    if (currentModalEventId) {
        resolveEvent(currentModalEventId);
        bootstrap.Modal.getInstance(document.getElementById('eventDetailModal')).hide();
    }
}

// ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ
function escHtml(s) {
    const d = document.createElement('div');
    d.textContent = s;
    return d.innerHTML;
}

function statusIcon(type) {
    const icons = {
        'active': 'üü¢', 'logged_out': '‚ö´', 'suspended': 'üî¥',
        'verification_required': 'üü°', '2fa_required': 'üü†',
        'action_blocked': 'üî¥', 'replaced': '‚ö™',
    };
    return icons[type] || '‚ùì';
}

function formatStatus(type) {
    return (type || '').replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
}

function timeAgo(dateStr) {
    if (!dateStr) return '-';
    const diff = (Date.now() - new Date(dateStr + 'Z').getTime()) / 1000;
    if (diff < 60) return 'just now';
    if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
    if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
    return Math.floor(diff / 86400) + 'd ago';
}

// ‚îÄ‚îÄ Replace Account Flow ‚îÄ‚îÄ
let pendingReplaceEventId = null;

function showReplaceModal(eventId) {
    pendingReplaceEventId = eventId;
    const body = document.getElementById('replaceModalBody');
    const confirmBtn = document.getElementById('confirmReplaceBtn');
    confirmBtn.disabled = true;
    body.innerHTML = '<div class="text-center py-3"><i class="fas fa-spinner fa-spin"></i> Loading replacement preview...</div>';

    new bootstrap.Modal(document.getElementById('replaceModal')).show();

    fetch('/api/account-health/replace-preview/' + eventId)
        .then(r => r.json())
        .then(data => {
            if (data.error) {
                body.innerHTML = '<div class="alert alert-danger">' + escHtml(data.error) + '</div>';
                return;
            }

            const old = data.old_account;
            const inv = data.new_account;

            if (!inv) {
                body.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        No available accounts in inventory (${data.available_inventory_count} available).
                        <br>Import more accounts in the <a href="/inventory" class="text-warning">Inventory page</a>.
                    </div>
                `;
                return;
            }

            confirmBtn.disabled = false;

            body.innerHTML = `
                <div class="replace-detail">
                    <div class="label">Removing (Flagged Account)</div>
                    <div class="value text-danger">@${escHtml(old.username)}</div>
                    <div class="mt-1 text-muted" style="font-size:.82rem;">
                        Device: <strong>${escHtml(old.device_serial)}</strong><br>
                        Package: <code>${escHtml(old.instagram_package)}</code><br>
                        Schedule: ${old.start_time || '0'}h ‚Äì ${old.end_time || '0'}h
                    </div>
                </div>

                <div class="replace-arrow">
                    <i class="fas fa-arrow-down"></i>
                </div>

                <div class="replace-detail">
                    <div class="label">Replacing With (From Inventory)</div>
                    <div class="value text-success">@${escHtml(inv.username)}</div>
                    <div class="mt-1 text-muted" style="font-size:.82rem;">
                        Email: ${escHtml(inv.email || 'N/A')}<br>
                        2FA: ${inv.two_factor_auth ? '‚úÖ Yes' : '‚ùå No'}
                    </div>
                </div>

                <div class="replace-warning mt-3">
                    <i class="fas fa-info-circle me-1"></i>
                    <strong>What will happen:</strong>
                    <ul class="mb-0 mt-1" style="padding-left:1.2rem;">
                        <li>App data for <code>${escHtml(old.instagram_package)}</code> will be cleared</li>
                        <li>New account inherits device, package &amp; schedule</li>
                        <li>Warmup mode: <strong>Reels only for 7 days</strong></li>
                        <li>Login task queued for next bot cycle</li>
                    </ul>
                </div>

                <div class="mt-2 text-muted" style="font-size:.78rem;">
                    ${data.available_inventory_count} account(s) available in inventory
                </div>
            `;
        })
        .catch(err => {
            body.innerHTML = '<div class="alert alert-danger">Failed to load preview: ' + escHtml(err.message) + '</div>';
        });
}

function confirmReplace() {
    if (!pendingReplaceEventId) return;

    const confirmBtn = document.getElementById('confirmReplaceBtn');
    confirmBtn.disabled = true;
    confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Replacing...';

    fetch('/api/account-health/replace', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ health_event_id: pendingReplaceEventId }),
    })
    .then(r => r.json())
    .then(data => {
        bootstrap.Modal.getInstance(document.getElementById('replaceModal')).hide();

        if (data.success) {
            let msg = `Replaced @${data.old_account} ‚Üí @${data.new_account}. Login queued for next bot cycle.`;
            if (!data.adb_clear_ok) {
                msg += ' (‚ö†Ô∏è ADB clear failed ‚Äî may need manual clear)';
            }
            showToast(msg, 'success');
        } else {
            showToast(data.error || 'Replace failed', 'error');
        }

        loadData();
    })
    .catch(err => {
        bootstrap.Modal.getInstance(document.getElementById('replaceModal')).hide();
        showToast('Replace error: ' + err.message, 'error');
    })
    .finally(() => {
        confirmBtn.disabled = false;
        confirmBtn.innerHTML = '<i class="fas fa-exchange-alt me-1"></i>Replace Account';
        pendingReplaceEventId = null;
    });
}

function showToast(message, type) {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = 'toast-msg' + (type === 'error' ? ' error' : '');
    toast.textContent = message;
    container.appendChild(toast);
    setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 5000);
}
</script>
{% endblock %}
