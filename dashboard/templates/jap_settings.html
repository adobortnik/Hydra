{% extends "base.html" %}

{% block content %}
<div class="container">
    <h1 class="mt-4 mb-4">JustAnotherPanel API Settings</h1>
    
    {% if message %}
    <div class="alert alert-success" role="alert">
        {{ message }}
    </div>
    {% endif %}
    
    {% if error %}
    <div class="alert alert-danger" role="alert">
        {{ error }}
    </div>
    {% endif %}
    
    <div class="card">
        <div class="card-header">
            <h5>API Configuration</h5>
        </div>
        <div class="card-body">
            <form method="POST" action="/jap-settings">
                <div class="form-group">
                    <label for="api_key">API Key</label>
                    <input type="text" class="form-control" id="api_key" name="api_key" value="{{ api_key }}" required>
                    <small class="form-text text-muted">Enter your JustAnotherPanel API key. This key will be used to authenticate requests to the JustAnotherPanel API.</small>
                </div>
                <button type="submit" class="btn btn-primary mt-3">Save API Key</button>
            </form>
        </div>
    </div>
    
    <div class="card mt-4">
        <div class="card-header">
            <h5>API Information</h5>
        </div>
        <div class="card-body">
            <p>This integration allows you to purchase Instagram followers directly from JustAnotherPanel.com.</p>
            <p>To use this feature:</p>
            <ol>
                <li>Sign up for an account at <a href="https://justanotherpanel.com" target="_blank">JustAnotherPanel.com</a></li>
                <li>Obtain your API key from your account dashboard</li>
                <li>Enter your API key above and save it</li>
                <li>Go to the Account Inventory page to purchase followers for your accounts</li>
            </ol>
            <p>For more information, please refer to the <a href="https://justanotherpanel.com/api/v2" target="_blank">JustAnotherPanel API documentation</a>.</p>
        </div>
    </div>
    
    <div class="card mt-4">
        <div class="card-header">
            <h5>Recent Orders</h5>
        </div>
        <div class="card-body">
            <div id="orders-container">
                <p>Loading orders...</p>
            </div>
        </div>
    </div>
</div>

<script>
    // Fetch and display orders when the page loads
    document.addEventListener('DOMContentLoaded', function() {
        fetchOrders();
    });
    
    function fetchOrders() {
        fetch('/api/jap/orders')
            .then(response => response.json())
            .then(data => {
                displayOrders(data);
            })
            .catch(error => {
                console.error('Error fetching orders:', error);
                document.getElementById('orders-container').innerHTML = '<p class="text-danger">Error loading orders. Please try again later.</p>';
            });
    }
    
    function displayOrders(orders) {
        const container = document.getElementById('orders-container');
        
        if (!orders || orders.length === 0 || (orders.error && orders.error === 'API key not configured')) {
            container.innerHTML = '<p>No orders found. Configure your API key to start ordering followers.</p>';
            return;
        }
        
        if (orders.error) {
            container.innerHTML = `<p class="text-danger">Error: ${orders.error}</p>`;
            return;
        }
        
        let html = '<table class="table table-striped">';
        html += '<thead><tr><th>Order ID</th><th>Username</th><th>Quantity</th><th>Status</th><th>Created</th><th>Actions</th></tr></thead>';
        html += '<tbody>';
        
        orders.forEach(order => {
            const createdDate = new Date(order.created_at).toLocaleString();
            
            html += `<tr>
                <td>${order.order_id}</td>
                <td>${order.username}</td>
                <td>${order.quantity}</td>
                <td>${order.status}</td>
                <td>${createdDate}</td>
                <td>
                    <button class="btn btn-sm btn-info" onclick="checkOrderStatus('${order.order_id}')">Check Status</button>
                </td>
            </tr>`;
        });
        
        html += '</tbody></table>';
        container.innerHTML = html;
    }
    
    function checkOrderStatus(orderId) {
        fetch(`/api/jap/order-status/${orderId}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(`Error: ${data.error}`);
                } else {
                    let statusMessage = `Status: ${data.status}\n`;
                    if (data.remains) statusMessage += `Remains: ${data.remains}\n`;
                    if (data.start_count) statusMessage += `Start Count: ${data.start_count}\n`;
                    if (data.charge) statusMessage += `Charge: ${data.charge} ${data.currency || 'USD'}`;
                    
                    alert(statusMessage);
                    fetchOrders(); // Refresh the orders list
                }
            })
            .catch(error => {
                console.error('Error checking order status:', error);
                alert('Error checking order status. Please try again later.');
            });
    }
</script>
{% endblock %}
